#!/bin/bash
# see http://standards.freedesktop.org/basedir-spec/basedir-spec-0.6.html for standard
# locations and environment variables

XDG_DATA_HOME=${XDG_DATA_HOME:-${HOME}/.local/share}
XDG_CONFIG_HOME=${XDG_CONFIG_HOME:-${HOME}/.config}

script_location="$(dirname "$0")"
# TODO: readlink -e doesn't work on Mac.
prefix=$(readlink -en "${script_location}/../..")
FW_DATA="${XDG_DATA_HOME}/fieldworks"
FW_CONFIG="${XDG_CONFIG_HOME}/fieldworks"
FW_SAMPLES=${FW_SAMPLES:-/usr/share/fieldworks-examples}
FW_LIB=$prefix/lib/fieldworks
FW_SHARE=$script_location

(
	if [ ! -d "${FW_CONFIG}/" ]; then
		echo "# Finishing user specific setup"
		mkdir -p "${FW_CONFIG}/Icu40/"
		cp -R "${FW_SHARE}/Icu40/icudt40l" "${FW_CONFIG}/Icu40/"
		cp -R "${FW_SHARE}/Icu40/data" "${FW_CONFIG}/Icu40/"
		cp -R "${FW_SHARE}/SIL" "${FW_CONFIG}/"
		mkdir -p "${FW_CONFIG}/MoveRepositoryTo"
		mkdir -p "${FW_DATA}/Projects"

		# copy sample databases
		if [ -d ${FW_SAMPLES}/ReleaseData ]; then
			for db in ${FW_SAMPLES}/ReleaseData/*; do
				dbname=$(basename "$db")
				echo "# Copying sample database $dbname"
				cp -r "$db" "${FW_DATA}/Projects/"
				chmod -R gu+w "${FW_DATA}/Projects/$dbname"
			done
		fi
	fi

	if [ ! -d "${FW_CONFIG}/registry/LocalMachine/software/sil" ]; then
		echo "# Updating configuration"

		cd "$FW_LIB"; RUNMODE="INSTALLED" source environ; cd "$OLDPWD"

		WRITEKEY="${FW_LIB}/WriteKey.exe"
		mono "${WRITEKEY}" LM "Software/SIL/FieldWorks/7.0" "RootDataDir" "${FW_CONFIG}/"
		mono "${WRITEKEY}" LM "Software/SIL" "Icu40DataDir" "${FW_CONFIG}/Icu40/icudt40l"
		mono "${WRITEKEY}" LM "Software/SIL/FieldWorks/7.0" "RootCodeDir" "${FW_SHARE}"
		mono "${WRITEKEY}" LM "Software/SIL" "Icu40Dir" "${FW_CONFIG}/Icu40"

		# REVIEW these were taken from nant setup registry may not be correct for an install.
		mono "${WRITEKEY}" LM "Software/SIL/EncodingConverterRepository" "Registry" "${FW_CONFIG}/SIL/Repository/mappingRegistry.xml"
		mono "${WRITEKEY}" LM "Software/SIL/EncodingConverterRepository" "MoveRepositoryTo" "${FW_CONFIG}/MoveRepositoryTo"
		mono "${WRITEKEY}" LM "Software/Microsoft/.NETFramework/AssemblyFolders" "Primary Interop Assemblies" "$FW_LIB"
		mono "${WRITEKEY}" LM "Software/SIL" "InitIcu" "1"
		mono "${WRITEKEY}" LM "Software/SIL/FieldWorks" "InstallLanguageUseLog" "False"
		mono "${WRITEKEY}" LM "Software/SIL/FieldWorks/7.0" "ProjectsDir" "${FW_DATA}/Projects"
	fi
) | zenity --progress \
	--title="User specific setup" \
	--percentage=0 \
	--pulsate \
	--auto-close
