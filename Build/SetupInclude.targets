<?xml version="1.0" encoding="utf-8"?>
<Project InitialTargets="Setup" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

	<PropertyGroup>
		<GitVersionMsBuildVersion>5.10.3</GitVersionMsBuildVersion>
		<IcuVersion>70</IcuVersion>
		<IcuWinFwLibVersion>70.1.152</IcuWinFwLibVersion>
		<LcmVersion>10.2.0-beta0067</LcmVersion>
		<NunitConsoleVersion>3.12.0</NunitConsoleVersion>
		<SilBuildTasksVersion>2.5.0</SilBuildTasksVersion>
		<SilLibVersion>6.0.11</SilLibVersion>

		<fwrt>$([System.IO.Directory]::GetParent($(MSBuildProjectDirectory)))</fwrt>
		<fwrt Condition="'$(fwrt)' == ''">$(MSBuildThisFileDirectory)..</fwrt>
		<GitVersionMsBuildProps>$(fwrt)/packages/GitVersion.MsBuild.$(GitVersionMsBuildVersion)/build/GitVersion.MsBuild.props</GitVersionMsBuildProps>
		<GitVersionMsBuildTargets>$(fwrt)/packages/GitVersion.MsBuild.$(GitVersionMsBuildVersion)/build/GitVersion.MsBuild.targets</GitVersionMsBuildTargets>
		<IcuWinFwLibProps>$(fwrt)/packages/Icu4c.Win.Fw.Lib.$(IcuWinFwLibVersion)/build/Icu4c.Win.Fw.Lib.props</IcuWinFwLibProps>
		<LcmCoreProps>$(fwrt)/packages/SIL.LCModel.Core.$(LcmVersion)/buildMultiTargeting/SIL.LCModel.Core.props</LcmCoreProps>
		<SilBuildTaskProps>$(fwrt)/packages/SIL.BuildTasks.$(SilBuildTasksVersion)/build/SIL.BuildTasks.props</SilBuildTaskProps>
		<NUnit3ConsolePath>$(fwrt)/packages/NUnit.ConsoleRunner.$(NunitConsoleVersion)/tools</NUnit3ConsolePath>
		<Nunit3Console>$(NUnit3ConsolePath)/nunit3-console.exe</Nunit3Console>

		<!--
			Check that all the nuget packages that we need in this build script exist in the
			correct version. Otherwise we'll have to install the package and then recursively
			call this build script again so that the files exist when we import them. If they
			all already exist we can just continue with our build.
		-->
		<RestartBuild Condition="(Exists('$(GitVersionMsBuildProps)') And Exists('$(IcuWinFwLibTargets)') And Exists('$(SilBuildTaskProps)') And Exists('$(NUnit3Console)')) Or '$(IsReentry)'=='true'">false</RestartBuild>
		<RestartBuild Condition="(!Exists('$(GitVersionMsBuildProps)') Or !Exists('$(IcuWinFwLibTargets)') Or !Exists('$(SilBuildTaskProps)') Or !Exists('$(NUnit3Console)')) And '$(IsReentry)'!='true'">true</RestartBuild>
	</PropertyGroup>

	<Import Project="$(GitVersionMsBuildProps)" Condition="Exists('$(GitVersionMsBuildProps)')" />
	<Import Project="$(GitVersionMsBuildTargets)" Condition="Exists('$(GitVersionMsBuildTargets)')" />
	<Import Project="$(IcuWinFwLibProps)" Condition="Exists('$(IcuWinFwLibProps)')" />
	<Import Project="$(IcuWinFwLibTargets)" Condition="Exists('$(IcuWinFwLibTargets)')" />
	<Import Project="$(LcmCoreProps)" Condition="Exists('$(LcmCoreProps)')" />
	<Import Project="$(SilBuildTaskProps)" Condition="Exists('$(SilBuildTaskProps)')" />

	<!-- config is generally either Debug or Release, but might be Bounds or Profile. -->
	<!-- if the user gives it lowercase, fix it to be capitalized -->
	<Choose>
		<When Condition="'$(config)'=='Debug'">
			<PropertyGroup>
				<config-lower>debug</config-lower>
				<config-capital>Debug</config-capital>
				<build-type>d</build-type>
			</PropertyGroup>
		</When>
		<When Condition="'$(config)'=='Release'">
			<PropertyGroup>
				<config-lower>release</config-lower>
				<config-capital>Release</config-capital>
				<build-type>r</build-type>
			</PropertyGroup>
		</When>
		<When Condition="'$(config)'=='Bounds'">
			<PropertyGroup>
				<config-lower>bounds</config-lower>
				<config-capital>Bounds</config-capital>
				<build-type>b</build-type>
			</PropertyGroup>
		</When>
		<When Condition="'$(config)'=='Profile'">
			<PropertyGroup>
				<config-lower>profile</config-lower>
				<config-capital>Profile</config-capital>
				<build-type>p</build-type>
			</PropertyGroup>
		</When>
		<When Condition="'$(config)'=='debug'">
			<PropertyGroup>
				<config-lower>debug</config-lower>
				<config-capital>Debug</config-capital>
				<build-type>d</build-type>
			</PropertyGroup>
		</When>
		<When Condition="'$(config)'=='release'">
			<PropertyGroup>
				<config-lower>release</config-lower>
				<config-capital>Release</config-capital>
				<build-type>r</build-type>
			</PropertyGroup>
		</When>
		<When Condition="'$(config)'=='bounds'">
			<PropertyGroup>
				<config-lower>bounds</config-lower>
				<config-capital>Bounds</config-capital>
				<build-type>b</build-type>
			</PropertyGroup>
		</When>
		<When Condition="'$(config)'=='profile'">
			<PropertyGroup>
				<config-lower>profile</config-lower>
				<config-capital>Profile</config-capital>
				<build-type>p</build-type>
			</PropertyGroup>
		</When>
		<Otherwise>
			<PropertyGroup>
				<config-lower>debug</config-lower>
				<config-capital>Debug</config-capital>
				<build-type>d</build-type>
			</PropertyGroup>
		</Otherwise>
	</Choose>

	<Target Name="Setup">
		<CallTarget Targets="RestoreBuildTasks" />
		<CallTarget Targets="SetupInternal"/><!-- Condition="!$(RestartBuild)" /-->
		<!-- NB (Hasso) 2022.11: If we restart the build to call SetupInternal,
			none of the properties get passed back out to the main build, so we start copying output files to C:\ -->
		<!-- <MSBuild Projects="$(MSBuildProjectFullPath)" Targets="SetupInternal"
			Properties="IsReentry=true" Condition="$(RestartBuild)" /> -->
	</Target>

  <Target Name="SetupInternal" DependsOnTargets="RestoreBuildTasks"><!-- cannot depend on GenerateVersionFiles, because that creates a file in Output/Common which CleanAll deletes -->

	<!-- refresh the FieldWorks.targets file that gets loaded -->
	<GenerateFwTargets TimeoutValuesFilePath="$(MSBuildThisFileDirectory)/TestTimeoutValues.xml"
		NUnitConsolePath="$(MSBuildThisFileDirectory)../packages/NUnit.ConsoleRunner.$(NunitConsoleVersion)/tools" />

	<PropertyGroup>
		<dir-fwobj>$([System.IO.Path]::Combine($(fwrt),Obj))</dir-fwobj>
		<dir-fwoutput >$([System.IO.Path]::Combine($(fwrt),Output))</dir-fwoutput>
		<dir-outputBase>$([System.IO.Path]::Combine($(dir-fwoutput),$(config-capital)))</dir-outputBase>
		<dir-fwoutputCommon>$([System.IO.Path]::Combine($(dir-fwoutput),Common))</dir-fwoutputCommon>
		<dir-buildOutputInterop>$(dir-outputBase)</dir-buildOutputInterop>
		<dir-fwlib>$([System.IO.Path]::Combine($(fwrt),Lib))</dir-fwlib>
		<dir-fwinstall>$([System.IO.Path]::Combine($(dir-fwoutput),install))</dir-fwinstall>
		<dir-fwdistfiles>$([System.IO.Path]::Combine($(fwrt),DistFiles))</dir-fwdistfiles>
		<dir-icuData>$([System.IO.Path]::Combine($(dir-fwdistfiles),Icu$(IcuVersion)))</dir-icuData>
		<msbuild-props>Configuration=$(config-capital);ReferencePath=$(dir-outputBase);ResolveAssemblyWarnOrErrorOnTargetArchitectureMismatch=None</msbuild-props>

		<excludedCategories>LongRunning,ByHand,SmokeTest</excludedCategories>
		<excludedCategories Condition="'$(desktopNotAvailable)'=='true'">$(excludedCategories),DesktopRequired</excludedCategories>
		<excludedCategories Condition="'$(runAllTests)'!=''">ByHand,SmokeTest</excludedCategories>
	</PropertyGroup>

	<!-- Set some environment variables needed by make (or nmake) -->
	<SetEnvVar Variable="PATH" Value="$(dir-outputBase);$(PATH);$(dir-outputBase)/lib/win-x64" Condition="'$(OS)'=='Windows_NT'"/>
	<SetEnvVar Variable="BUILD_TYPE" Value="$(build-type)"/>
	<SetEnvVar Variable="BUILD_CONFIG" Value="$(config-capital)" />
	<SetEnvVar Variable="BUILD_ROOT" Value="$(fwrt)" />
	<SetEnvVar Variable="ICU_DATA" Value="$(fwrt)/DistFiles/Icu$(IcuVersion)" />

	<!-- Copy ICU header files -->
    <ItemGroup>
      <Icu4cIncludes Include="$(IcuFwIncludeDirectory)unicode/*.h" />
    </ItemGroup>
    <Copy SourceFiles="@(Icu4cIncludes)" DestinationFolder="$(fwrt)/Include/unicode" SkipUnchangedFiles="true" OverwriteReadOnlyFiles="true" />

	<!-- Copy dependencies needed for ParatextPlugin -->
	<ItemGroup>
		<ParatextDeps Include="$(fwrt)/packages/SIL.Lib.$(SilLibVersion)/lib/net46/SIL.*" />
	</ItemGroup>
	<Copy SourceFiles="@(ParatextDeps)" DestinationFolder="$(dir-outputBase)/lib/ParatextDeps"
		SkipUnchangedFiles="true" OverwriteReadOnlyFiles="true"/>

	<!-- Create the output directories if they don't already exist -->

	<Message Text="msbuild-target='$(msbuild-target)'; msbuild-props='$(msbuild-props)'"/>
  </Target>

  <Target Name="DeleteTestFiles">
	<ItemGroup>
		<TestFilesToDelete Include="$(dir-outputBase)\*-nunit-output.xml" />
	</ItemGroup>
	<Delete Files="@(TestFilesToDelete)" />
	<Message Text="Finished deleting NUnit report files." Importance="normal" />
  </Target>

  <Target Name="Initialize" DependsOnTargets="MakeDirs;GenerateVersionFiles"/>

  <Target Name="MakeDirs" DependsOnTargets="Setup;DeleteTestFiles" Condition="'$(action)'!='clean'">
	<MakeDir Directories="$(dir-fwobj);$(dir-outputBase);$(dir-fwoutputCommon)"/>
  </Target>

	<!-- Generate Output/Common/bldinc.h from Src/bldinc.h -->
	<PropertyGroup>
		<BldIncTemplate>../Src/bldinc.h</BldIncTemplate>
		<BldIncOutput>../Output/Common/bldinc.h</BldIncOutput>
		<VersionPropertiesFile>../Output/Common/Version.txt</VersionPropertiesFile>
	</PropertyGroup>
	<!--
		Don't use Inputs and Outputs on the GenerateVersionFiles Target.  (Substitute won't
		write the file if it hasn't changed, but the AssemblyFileVersion datestamp field should
		change once a day.)
	-->
	<Target Name="GenerateVersionFiles">
		<CallTarget Targets="GenerateVersionFilesInternal" Condition="!$(RestartBuild)" />
		<MSBuild Projects="$(MSBuildProjectFullPath)" Targets="GenerateVersionFilesInternal"
			Properties="IsReentry=true" Condition="$(RestartBuild)" />
	</Target>
	<Target Name="GenerateVersionFilesInternal" DependsOnTargets="MakeDirs;GetVersion" Condition="'$(action)'!='clean'">
		<WriteLinesToFile File="$(VersionPropertiesFile)" Lines="FWMAJOR=$(GitVersion_Major);FWMINOR=$(GitVersion_Minor);FWREVISION=$(GitVersion_Patch)" Overwrite="true" />
		<Substitute Template="$(BldIncTemplate)" Symbols="$(VersionPropertiesFile)"
			Output="$(BldIncOutput)" Condition="'$(action)'!='clean' And Exists('../Output/Common')"/>

		<Message Text="Updated bldinc.h"/>
	</Target>

  <PropertyGroup>
	<BUILD_LEVEL Condition="'$(BUILD_LEVEL)'==''">9</BUILD_LEVEL>
	<!-- action is one of the following: build test clean register unregister -->
	<action Condition="'$(action)'==''">build</action>
	<!-- target is one of the targets in the build system. -->
	<target Condition="'$(target)'==''">all</target>
	<platform Condition="'$(platform)'=='' And '$(OS)'=='Windows_NT'">WIN32</platform>
	<verbose Condition="'$(verbose)'==''">false</verbose>
	<buildtlb Condition="'$(buildtlb)'==''">false</buildtlb>
	<!-- <warningsAsErrors Condition="'$(warningsAsErrors)'==''">TreatWarningsAsErrors=true</warningsAsErrors> -->
	<timeoutFudgeFactor Condition="'$(timeoutFudgeFactor)'==''">1</timeoutFudgeFactor>
	<useNUnit-x86 >false</useNUnit-x86>
	<defines Condition="'$(config-lower)'=='release'">TRACE;CODE_ANALYSIS</defines>
	<defines Condition="'$(config-lower)'!='release'">DEBUG;TRACE;CODE_ANALYSIS</defines>
  </PropertyGroup>

  <Choose>
	<When Condition="'$(action)'=='build'">
	  <PropertyGroup>
		<msbuild-target>Restore;Build</msbuild-target>
		<make-target>all</make-target>
	  </PropertyGroup>
	</When>
	<When Condition="'$(action)'=='clean'">
	  <PropertyGroup>
		<msbuild-target>Clean</msbuild-target>
		<make-target>clean</make-target>
	  </PropertyGroup>
	</When>
	<When Condition="'$(action)'=='rebuild'">
	  <PropertyGroup>
		<msbuild-target>Restore;Rebuild</msbuild-target>
		<make-target>clean all</make-target>
	  </PropertyGroup>
	</When>
	<Otherwise>
	  <PropertyGroup>
		<msbuild-target>Restore;Build</msbuild-target>
		<make-target>all</make-target>
	  </PropertyGroup>
	</Otherwise>
  </Choose>

	<PropertyGroup>
		<!--
			Property for running on build agents. The environment variable BUILDAGENT_SUBKEY
			gets set by the Jenkins build.
			The strings need to be in sync with BasicUtilsTests/Attributes/RedirectHKCU.cs and
			Generic/RedirectHKCU.h
		-->
		<BUILDAGENT_HKCU Condition="'$(BUILDAGENT_SUBKEY)' != ''">Software\SIL\BuildAgents\$(BUILDAGENT_SUBKEY)\HKCU\</BUILDAGENT_HKCU>
	</PropertyGroup>

</Project>
