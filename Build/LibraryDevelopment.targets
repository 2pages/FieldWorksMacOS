<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="15.0">
	<UsingTask TaskName="MSBuild.ExtensionPack.UI.Console" AssemblyFile="../packages/MSBuild.Extension.Pack.1.9.1/tools/net40/MSBuild.ExtensionPack.dll"/>
	<Import Project="LibraryDevelopment.properties" Condition="Exists('LibraryDevelopment.properties')"/>
	<Target Name="UpdateDevelopmentPropertiesFile">
		<!-- Yellow text to catch the user's attention -->
		<Warning Text="FW can use locally-built or downloaded (default) artifacts for LCM, Palaso, and Chorus, as configured by LibraryDevelopment.properties, which was not found." />
		<MSBuild.ExtensionPack.UI.Console TaskAction="ReadLine" UserPrompt="Would you like to use artifacts from local libraries to build, instead of downloading them? (y/N)" ToUpper="true">
			<Output TaskParameter="UserResponse" PropertyName="UseLocalLibraries"/>
		</MSBuild.ExtensionPack.UI.Console>
		<PropertyGroup>
			<!-- UseLocalLibraries is required to have a non-empty value to pass as a property in xbuild -->
			<UseLocalLibraries Condition="'$(UseLocalLibraries)'!='Y'">N</UseLocalLibraries>
		</PropertyGroup>
		<MSBuild.ExtensionPack.UI.Console TaskAction="ReadLine" UserPrompt="What is the libpalaso output path?" Condition="'$(UseLocalLibraries)'=='Y'">
			<Output TaskParameter="UserResponse" PropertyName="PalasoArtifactsDir"/>
		</MSBuild.ExtensionPack.UI.Console>
		<MSBuild.ExtensionPack.UI.Console TaskAction="ReadLine" UserPrompt="What is the chorus output path?" Condition="'$(UseLocalLibraries)'=='Y'">
			<Output TaskParameter="UserResponse" PropertyName="ChorusArtifactsDir"/>
		</MSBuild.ExtensionPack.UI.Console>
		<MSBuild.ExtensionPack.UI.Console TaskAction="ReadLine" UserPrompt="What is the liblcm output path?" Condition="'$(UseLocalLibraries)'=='Y'">
			<Output TaskParameter="UserResponse" PropertyName="LcmLocalArtifactsDir"/>
		</MSBuild.ExtensionPack.UI.Console>
		<MSBuild Projects="$(MSBuildProjectFullPath)" Targets="WriteDevelopmentPropertiesFile"
			Properties="UseLocalLibraries=$(UseLocalLibraries);PalasoArtifactsDir=$(PalasoArtifactsDir);
						ChorusArtifactsDir=$(ChorusArtifactsDir);LcmLocalArtifactsDir=$(LcmLocalArtifactsDir)"/>
	</Target>
	<Target Name="WriteDevelopmentPropertiesFile">
		<!-- Using .temp file since it seemed xbuild was sometimes loading the .properties file while it was being composed. -->
		<WriteLinesToFile File="LibraryDevelopment.properties.temp" Overwrite="true" Lines="&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;" />
		<WriteLinesToFile File="LibraryDevelopment.properties.temp" Lines="&lt;!-- This file is generated by the (Update|Write)DevelopmentPropertiesFile task --&gt;" />
		<WriteLinesToFile File="LibraryDevelopment.properties.temp" Lines="&lt;Project xmlns=&quot;http://schemas.microsoft.com/developer/msbuild/2003&quot; ToolsVersion=&quot;4.0&quot;&gt;" />
		<WriteLinesToFile File="LibraryDevelopment.properties.temp" Lines="&lt;PropertyGroup&gt;" />
		<WriteLinesToFile File="LibraryDevelopment.properties.temp" Lines="&lt;UseLocalLibraries&gt;$(UseLocalLibraries)&lt;/UseLocalLibraries&gt;" />
		<WriteLinesToFile File="LibraryDevelopment.properties.temp" Lines="&lt;PalasoArtifactsDir Condition=&quot;'%24(UseLocalLibraries)'=='Y'&quot;&gt;$(PalasoArtifactsDir)&lt;/PalasoArtifactsDir&gt;" />
		<WriteLinesToFile File="LibraryDevelopment.properties.temp" Lines="&lt;ChorusArtifactsDir Condition=&quot;'%24(UseLocalLibraries)'=='Y'&quot;&gt;$(ChorusArtifactsDir)&lt;/ChorusArtifactsDir&gt;" />
		<WriteLinesToFile File="LibraryDevelopment.properties.temp" Lines="&lt;!-- For localization, we always need to have access to the full LCM repository. Its location is calculated from %24(LcmLocalArtifactsDir). --&gt;" />
		<WriteLinesToFile File="LibraryDevelopment.properties.temp" Lines="&lt;LcmLocalArtifactsDir &gt;$(LcmLocalArtifactsDir)&lt;/LcmLocalArtifactsDir&gt;" />
		<WriteLinesToFile File="LibraryDevelopment.properties.temp" Lines="&lt;LcmArtifactsDir Condition=&quot;'%24(UseLocalLibraries)'=='Y'&quot;&gt;%24(LcmLocalArtifactsDir)&lt;/LcmArtifactsDir&gt;" />
		<WriteLinesToFile File="LibraryDevelopment.properties.temp" Lines="&lt;/PropertyGroup&gt;" />
		<WriteLinesToFile File="LibraryDevelopment.properties.temp" Lines="&lt;/Project&gt;" />
		<!-- Copy and Delete is easier than Move in mono4 xbuild. -->
		<Copy SourceFiles="LibraryDevelopment.properties.temp" DestinationFiles="LibraryDevelopment.properties" />
		<Delete Files="LibraryDevelopment.properties.temp" />
		</Target>

	<Target Name="WriteNonlocalDevelopmentPropertiesFile">
		<Message Text="Writing to LibraryDevelopment.properties, to not use local libraries."/>
		<CallTarget Targets="SetUseLocalLibrariesNo" />
		<CallTarget Targets="WriteDevelopmentPropertiesFile" />
	</Target>

	<Target Name="SetUseLocalLibrariesNo">
		<PropertyGroup>
			<UseLocalLibraries>N</UseLocalLibraries>
		</PropertyGroup>
	</Target>

	<Target Name="CheckDevelopmentPropertiesFile">
		<CallTarget Targets="UpdateDevelopmentPropertiesFile" Condition="!Exists('LibraryDevelopment.properties')" />
	</Target>
</Project>