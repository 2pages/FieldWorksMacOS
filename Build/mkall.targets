<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="4.0">

  <!-- Make all of FieldWorks. -->
  <Target Name="mkall" DependsOnTargets="allCpp;allCsharp">
	<Message Text="Finished mkall Target."/>
  </Target>

  <Target Name="allCpp" DependsOnTargets="DebugProcs;GenericLib;testGenericLib;FwKernel;testFwKernel;Language;testLanguage;Views;testViews;GrEngine"/>
  <Target Name="allCppNoTest" DependsOnTargets="DebugProcs;GenericLib;FwKernel;Language;Views;GrEngine"/>

  <Target Name="DebugProcs" DependsOnTargets="initLinux">
	<CreateProperty Value="all" Condition="'$(action)'=='test'">
	  <Output TaskParameter="Value" PropertyName="make-target"/>
	</CreateProperty>
	<Make Condition="'$(OS)'=='Windows_NT'"
	  Makefile="$(fwrt)\Src\DebugProcs\DebugProcs.mak"
	  Configuration="$(config)"
	  BuildRoot="$(fwrt)"
	  WorkingDirectory="$(fwrt)\Src\DebugProcs"/>
	<Make Condition="'$(OS)'=='Unix'" ToolPath="/usr/bin"
	  Makefile="$(fwrt)/Src/DebugProcs/Makefile"
	  Configuration="$(config)" Target="$(make-target)"
	  BuildRoot="$(fwrt)"
	  WorkingDirectory="$(fwrt)/Src/DebugProcs"/>
  </Target>

  <Target Name="GenericLib" DependsOnTargets="initLinux;DebugProcs">
	<CreateProperty Value="all" Condition="'$(action)'=='test'">
	  <Output TaskParameter="Value" PropertyName="make-target"/>
	</CreateProperty>
	<Make Condition="'$(OS)'=='Windows_NT'"
	  Makefile="$(fwrt)\Src\Generic\GenericLib.mak"
	  Configuration="$(config)"
	  BuildRoot="$(fwrt)"
	  WorkingDirectory="$(fwrt)\Src\Generic"/>
	<Make Condition="'$(OS)'=='Unix'" ToolPath="/usr/bin"
	  Makefile="$(fwrt)/Src/Generic/Makefile"
	  Configuration="$(config)" Target="$(make-target)"
	  BuildRoot="$(fwrt)"
	  WorkingDirectory="$(fwrt)/Src/Generic"/>
  </Target>

  <Target Name="testGenericLib" DependsOnTargets="GenericLib">
	<CreateProperty Value="check" Condition="'$(action)'=='test'">
	  <Output TaskParameter="Value" PropertyName="make-target"/>
	</CreateProperty>
	<Make Condition="'$(OS)'=='Windows_NT'"
	  Makefile="$(fwrt)\Src\Generic\Test\testGenericLib.mak"
	  Configuration="$(config)"
	  BuildRoot="$(fwrt)"
	  WorkingDirectory="$(fwrt)\Bin"/>
	<Make Condition="'$(OS)'=='Unix'" ToolPath="/usr/bin"
	  Makefile="$(fwrt)/Src/Generic/Test/Makefile"
	  Configuration="$(config)" Target="$(make-target)"
	  BuildRoot="$(fwrt)"
	  WorkingDirectory="$(fwrt)/Src/Generic/Test"/>
	<Exec Command="$(dir-outputBase)\testGenericLib.exe"
		  WorkingDirectory="$(dir-outputBase)"
		  Condition="'$(OS)'=='Windows_NT' And '$(action)'=='test'"/>
  </Target>

  <Target Name="GrEngine" DependsOnTargets="GenericLib;FwKernel">
	<CreateProperty Value="all" Condition="'$(action)'=='test'">
	  <Output TaskParameter="Value" PropertyName="make-target"/>
	</CreateProperty>
	<Make Condition="'$(OS)'=='Windows_NT'"
	  Makefile="$(fwrt)\Src\Graphite\GrEngine\GrEngine.mak"
	  Configuration="$(config)"
	  BuildRoot="$(fwrt)"
	  WorkingDirectory="$(fwrt)\Src\Graphite\GrEngine"/>
	<Make Condition="'$(OS)'=='Unix'" ToolPath="/usr/bin"
	  Makefile="$(fwrt)/Src/Graphite/GrEngine/Makefile"
	  Configuration="$(config)" Target="$(make-target)"
	  BuildRoot="$(fwrt)"
	  WorkingDirectory="$(fwrt)/Src/Graphite/GrEngine"/>
  </Target>

  <Target Name="FwKernel" DependsOnTargets="GenericLib;GenerateCellarConstants;AppCore">
	<CreateProperty Value="all" Condition="'$(action)'=='test'">
	  <Output TaskParameter="Value" PropertyName="make-target"/>
	</CreateProperty>
	<Message Text="FwKernel make-target='$(make-target)'"/>
	<Make Condition="'$(OS)'=='Windows_NT'"
	  Makefile="$(fwrt)\Src\Kernel\FwKernel.mak"
	  Configuration="$(config)"
	  BuildRoot="$(fwrt)"
	  WorkingDirectory="$(fwrt)\Src\Kernel"/>
	<Make Condition="'$(OS)'=='Unix'" ToolPath="/usr/bin"
	  Makefile="$(fwrt)/Src/Kernel/Makefile"
	  Configuration="$(config)" Target="$(make-target)"
	  BuildRoot="$(fwrt)"
	  WorkingDirectory="$(fwrt)/Src/Kernel"/>
  </Target>

  <Target Name="testFwKernel" DependsOnTargets="GenericLib;FwKernel">
	<CreateProperty Value="check" Condition="'$(action)'=='test'">
	  <Output TaskParameter="Value" PropertyName="make-target"/>
	</CreateProperty>
	<Make Condition="'$(OS)'=='Windows_NT'"
	  Makefile="$(fwrt)\Src\Kernel\Test\testFwKernel.mak"
	  Configuration="$(config)"
	  BuildRoot="$(fwrt)"
	  WorkingDirectory="$(fwrt)\Bin"/>
	<Make Condition="'$(OS)'=='Unix'" ToolPath="/usr/bin"
	  Makefile="$(fwrt)/Src/Kernel/Test/Makefile"
	  Configuration="$(config)" Target="$(make-target)"
	  BuildRoot="$(fwrt)"
	  WorkingDirectory="$(fwrt)/Src/Kernel/Test"/>
	<RegFree Executable="$(dir-outputBase)\testFwKernel.exe"
			 Dlls="$(dir-outputBase)\FwKernel.dll"
			 Condition="'$(OS)'=='Windows_NT'"/>
	<Exec Command="mt.exe -outputresource:$(dir-outputBase)\testFwKernel.exe -manifest $(dir-outputBase)\testFwKernel.exe.manifest"
		  Condition="'$(OS)'=='Windows_NT'"/>
	<Exec Command="$(dir-outputBase)\testFwKernel.exe"
		  WorkingDirectory="$(dir-outputBase)"
		  Condition="'$(OS)'=='Windows_NT' And '$(action)'=='test'"/>
  </Target>

  <Target Name="AppCore" DependsOnTargets="DebugProcs;GenericLib">
	<CreateProperty Value="all" Condition="'$(action)'=='test'">
	  <Output TaskParameter="Value" PropertyName="make-target"/>
	</CreateProperty>
	<Message Text="AppCore make-target='$(make-target)'"/>
	<Make Condition="'$(OS)'=='Unix'" ToolPath="/usr/bin"
	  Makefile="$(fwrt)/Src/AppCore/Makefile"
	  Configuration="$(config)" Target="$(make-target)"
	  BuildRoot="$(fwrt)"
	  WorkingDirectory="$(fwrt)/Src/AppCore"/>
  </Target>

  <Target Name="Language" DependsOnTargets="GenericLib;FwKernel;ManagedLgIcuCollator;GenerateCellarConstants">
	<CreateProperty Value="all" Condition="'$(action)'=='test'">
	  <Output TaskParameter="Value" PropertyName="make-target"/>
	</CreateProperty>
	<Make Condition="'$(OS)'=='Windows_NT'"
	  Makefile="$(fwrt)\Src\Language\Language.mak"
	  Configuration="$(config)"
	  BuildRoot="$(fwrt)"
	  WorkingDirectory="$(fwrt)\Src\Language"/>
	<Make Condition="'$(OS)'=='Unix'" ToolPath="/usr/bin"
	  Makefile="$(fwrt)/Src/Language/Makefile"
	  Configuration="$(config)" Target="$(make-target)"
	  BuildRoot="$(fwrt)"
	  WorkingDirectory="$(fwrt)/Src/Language"/>
  </Target>

  <Target Name="testLanguage" DependsOnTargets="GenericLib;Language;FwKernel;Views;GrEngine">
	<CreateProperty Value="check" Condition="'$(action)'=='test'">
	  <Output TaskParameter="Value" PropertyName="make-target"/>
	</CreateProperty>
	<Make Condition="'$(OS)'=='Windows_NT'"
	  Makefile="$(fwrt)\Src\Language\Test\testLanguage.mak"
	  Configuration="$(config)"
	  BuildRoot="$(fwrt)"
	  WorkingDirectory="$(fwrt)\Bin"/>
	<Make Condition="'$(OS)'=='Unix'" ToolPath="/usr/bin"
	  Makefile="$(fwrt)/Src/Language/Test/Makefile"
	  Configuration="$(config)" Target="$(make-target)"
	  BuildRoot="$(fwrt)"
	  WorkingDirectory="$(fwrt)/Src/Language/Test"/>
	<RegFree Executable="$(dir-outputBase)\testLanguage.exe"
			 Dlls="$(dir-outputBase)\Language.dll;$(dir-outputBase)\FwKernel.dll;$(dir-outputBase)\Graphite.dll;$(dir-outputBase)\Views.dll"
			 Condition="'$(OS)'=='Windows_NT'"/>
	<Exec Command="mt.exe -outputresource:$(dir-outputBase)\testLanguage.exe -manifest $(dir-outputBase)\testLanguage.exe.manifest"
		  Condition="'$(OS)'=='Windows_NT'"/>
	<Exec Command="$(dir-outputBase)\testLanguage.exe"
		  WorkingDirectory="$(dir-outputBase)"
		  Condition="'$(OS)'=='Windows_NT' And '$(action)'=='test'"/>
  </Target>

  <Target Name="Views" DependsOnTargets="GenericLib;Language;KeyboardSwitcher;GenerateCellarConstants"><!-- mktlbs -->
	<CreateProperty Value="all" Condition="'$(action)'=='test'">
	  <Output TaskParameter="Value" PropertyName="make-target"/>
	</CreateProperty>
	<Make Condition="'$(OS)'=='Windows_NT'"
	  Makefile="$(fwrt)\Src\views\Views.mak"
	  Configuration="$(config)"
	  BuildRoot="$(fwrt)"
	  WorkingDirectory="$(fwrt)\Src\views"/>
	<Make Condition="'$(OS)'=='Unix'" ToolPath="/usr/bin"
	  Makefile="$(fwrt)/Src/views/Makefile"
	  Configuration="$(config)" Target="$(make-target)"
	  BuildRoot="$(fwrt)"
	  WorkingDirectory="$(fwrt)/Src/views"/>
  </Target>

  <Target Name="testViews" DependsOnTargets="GenericLib;Views">
	<CreateProperty Value="check" Condition="'$(action)'=='test'">
	  <Output TaskParameter="Value" PropertyName="make-target"/>
	</CreateProperty>
	<Make Condition="'$(OS)'=='Windows_NT'"
	  Makefile="$(fwrt)\Src\views\Test\testViews.mak"
	  Configuration="$(config)"
	  BuildRoot="$(fwrt)"
	  WorkingDirectory="$(fwrt)\Bin"/>
	<Make Condition="'$(OS)'=='Unix'" ToolPath="/usr/bin"
	  Makefile="$(fwrt)/Src/views/Test/Makefile"
	  Configuration="$(config)" Target="$(make-target)"
	  BuildRoot="$(fwrt)"
	  WorkingDirectory="$(fwrt)/Src/views/Test"/>
	<RegFree Executable="$(dir-outputBase)\testViews.exe"
			 Dlls="$(dir-outputBase)\Language.dll;$(dir-outputBase)\FwKernel.dll;$(dir-outputBase)\Graphite.dll;$(dir-outputBase)\Views.dll"
			 Condition="'$(OS)'=='Windows_NT'"/>
	<Exec Command="mt.exe -outputresource:$(dir-outputBase)\testViews.exe -manifest $(dir-outputBase)\testViews.exe.manifest"
		  Condition="'$(OS)'=='Windows_NT'"/>
	<Exec Command="$(dir-outputBase)\testViews.exe"
		  WorkingDirectory="$(dir-outputBase)"
		  Condition="'$(OS)'=='Windows_NT' And '$(action)'=='test'"/>
  </Target>

  <ItemGroup>
	<CellarConstantsInputs Include="$(fwrt)/Src/FDO/MasterFieldWorksModel.xml"/>
	<CellarConstantsInputs Include="$(fwrt)/Src/bldinc.h"/>
	<CellarConstantsInputs Include="$(fwrt)/Src/Kernel/CellarBaseConstants.h"/>
	<CellarConstantsOutputs Include="$(fwrt)/Output/Common/CellarConstants.h"/>
	<CellarConstantsOutputs Include="$(fwrt)/Output/Common/bldinc.h"/>
	<CellarConstantsOutputs Include="$(fwrt)/Output/Common/CellarBaseConstants.h"/>
  </ItemGroup>

  <ItemGroup>
	<BldIncTemplate Include="$(fwrt)/Src/bldinc.h"/>
	<BldIncVersion Include="$(fwrt)/Src/MasterVersionInfo.txt"/>
	<BldIncOutput Include="$(fwrt)/Output/Common/bldinc.h"/>
  </ItemGroup>

  <Target Name="GenerateCellarConstants" Inputs="@(CellarConstantsInputs)" Outputs="@(CellarConstantsOutputs)">
	<MakeDir Directories="$(dir-fwoutputCommon)"/>
	<FdoGenerate XmlFile="$(fwrt)/Src/FDO/MasterFieldWorksModel.xml"
		 OutputDir="$(dir-fwoutputCommon)"
		 OutputFile="CellarConstants.h"
		 TemplateFile="$(fwrt)/Src/FDO/FDOGenerate/CellarConstants.vm.h"
		 WorkingDirectory="$(fwrt)/Src/FDO"/>
	<Substitute Template="@(BldIncTemplate)"
				Symbols="@(BldIncSymbols)"
				Output="@(BldIncOutput)"/>
	<Copy SourceFiles="$(fwrt)/Src/Kernel/CellarBaseConstants.h"
		  DestinationFolder="$(fwrt)/Output/Common"
		  SkipUnchangedFiles="true" OverwriteReadOnlyFiles="true"/>
  </Target>

  <PropertyGroup>
	<Original-OBJ_DIR>$(OBJ_DIR)</Original-OBJ_DIR>
	<Original-BUILD4UX>$(BUILD4UX)</Original-BUILD4UX>
	<Original-ANAL_TYPE>$(ANAL_TYPE)</Original-ANAL_TYPE>
  </PropertyGroup>

  <Target Name="mktlbs" DependsOnTargets="GenerateCellarConstants">
	<SetEnvVar Variable="BUILD_OUTPUT" Value="$(dir-fwoutput)" />
	<SetEnvVar Variable="OBJ_DIR" Value="$(dir-fwobj)" />
	<SetEnvVar Variable="BUILD4UX" Value="$(build4ux)"/>
	<SetEnvVar Variable="ANAL_TYPE" Value="performance" Condition="'$(performance)'=='true'"/>
	<Make Condition="'$(OS)'=='Windows_NT'"
		  Makefile="$(fwrt)\Src\Language\Language.mak"
		  Configuration="$(config)"
		  Target="dirs $(dir-fwoutputCommon)\LanguageTlb.tlb"
		  BuildRoot="$(fwrt)"
		  WorkingDirectory="$(fwrt)"/>
	<Make Condition="'$(OS)'=='Windows_NT'"
		  Makefile="$(fwrt)\Src\Kernel\FwKernel.mak"
		  Configuration="$(config)"
		  Target="dirs $(dir-fwoutputCommon)\FwKernelTlb.tlb"
		  BuildRoot="$(fwrt)"
		  WorkingDirectory="$(fwrt)"/>
	<Make Condition="'$(OS)'=='Windows_NT'"
		  Makefile="$(fwrt)\Src\views\Views.mak"
		  Configuration="$(config)"
		  Target="dirs $(dir-fwoutputCommon)\ViewsTlb.tlb"
		  BuildRoot="$(fwrt)"
		  WorkingDirectory="$(fwrt)"/>
	<SetEnvVar Variable="BUILD_OUTPUT" Value="$(Original-BUILD_OUTPUT)" />
	<SetEnvVar Variable="OBJ_DIR" Value="$(Original-OBJ_DIR)" />
	<SetEnvVar Variable="BUILD4UX" Value="$(Original-BUILD4UX)" />
	<SetEnvVar Variable="ANAL_TYPE" Value="$(Original-ANAL_TYPE)" />
  </Target>

</Project>
