<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="4.0">

	<!-- Make all of FieldWorks. -->
	<Target Name="mkall" DependsOnTargets="initLinux;initWindows;allCpp;allCsharp">
		<Message Text="Finished mkall Target."/>
		<CreateItem Condition="'$(action)'=='test'" Include="$(dir-outputBase)/*-nunit-output.xml">
			<Output TaskParameter="Include" ItemName="NUnitReportFiles"/>
		</CreateItem>
		<GenerateNUnitReports Condition="'$(action)'=='test'" ReportFiles="@(NUnitReportFiles)"/>
	</Target>

	<Target Name="allCpp" DependsOnTargets="DebugProcs;GenericLib;testGenericLib;FwKernel;testFwKernel;Language;testLanguage;Views;testViews;GrEngine;createCompMaps">
		<CreateItem Include="$(dir-outputBase)/*.compmap">
			<Output TaskParameter="Include" ItemName="CompMapFiles"/>
		</CreateItem>
		<CatenateFiles SourceFiles="@(CompMapFiles)" TargetFile="$(dir-outputBase)/components.map" Condition="'$(OS)'=='Unix'"/>
	</Target>
	<Target Name="allCppNoTest" DependsOnTargets="DebugProcs;GenericLib;FwKernel;Language;Views;GrEngine;createCompMaps">
		<CreateItem Include="$(dir-outputBase)/*.compmap">
			<Output TaskParameter="Include" ItemName="CompMapFiles"/>
		</CreateItem>
		<CatenateFiles SourceFiles="@(CompMapFiles)" TargetFile="$(dir-outputBase)/components.map" Condition="'$(OS)'=='Unix'"/>
	</Target>

	<Target Name="DebugProcs" DependsOnTargets="initLinux;initWindows">
		<CreateProperty Value="all" Condition="'$(action)'=='test'">
			<Output TaskParameter="Value" PropertyName="make-target"/>
		</CreateProperty>
		<Make Condition="'$(OS)'=='Windows_NT'"
			  Makefile="$(fwrt)\Src\DebugProcs\DebugProcs.mak"
			  Configuration="$(config-capital)"
			  BuildRoot="$(fwrt)"
			  WorkingDirectory="$(fwrt)\Src\DebugProcs"/>
		<Make Condition="'$(OS)'=='Unix'" ToolPath="/usr/bin"
			  Makefile="$(fwrt)/Src/DebugProcs/Makefile"
			  Configuration="$(config-capital)" Target="$(make-target)"
			  BuildRoot="$(fwrt)"
			  WorkingDirectory="$(fwrt)/Src/DebugProcs"/>
		<Message Text="Finished building DebugProcs."/>
	</Target>

	<Target Name="GenericLib" DependsOnTargets="DebugProcs">
		<CreateProperty Value="all" Condition="'$(action)'=='test'">
			<Output TaskParameter="Value" PropertyName="make-target"/>
		</CreateProperty>
		<Make Condition="'$(OS)'=='Windows_NT'"
			  Makefile="$(fwrt)\Src\Generic\GenericLib.mak"
			  Configuration="$(config-capital)"
			  BuildRoot="$(fwrt)"
			  WorkingDirectory="$(fwrt)\Src\Generic"/>
		<Make Condition="'$(OS)'=='Unix'" ToolPath="/usr/bin"
			  Makefile="$(fwrt)/Src/Generic/Makefile"
			  Configuration="$(config-capital)" Target="$(make-target)"
			  BuildRoot="$(fwrt)"
			  WorkingDirectory="$(fwrt)/Src/Generic"/>
		<Message Text="Finished building GenericLib."/>
	</Target>

	<Target Name="testGenericLib" DependsOnTargets="GenericLib">
		<CreateProperty Value="check" Condition="'$(action)'=='test'">
			<Output TaskParameter="Value" PropertyName="make-target"/>
		</CreateProperty>
		<Make Condition="'$(OS)'=='Windows_NT'"
			  Makefile="$(fwrt)\Src\Generic\Test\testGenericLib.mak"
			  Configuration="$(config-capital)"
			  BuildRoot="$(fwrt)"
			  WorkingDirectory="$(fwrt)\Bin"/>
		<Make Condition="'$(OS)'=='Unix'" ToolPath="/usr/bin"
			  Makefile="$(fwrt)/Src/Generic/Test/Makefile"
			  Configuration="$(config-capital)" Target="$(make-target)"
			  BuildRoot="$(fwrt)"
			  WorkingDirectory="$(fwrt)/Src/Generic/Test" ContinueOnError="true"/>
		<RegFree Executable="$(dir-outputBase)\testGenericLib.exe"
				 Dlls="$(dir-outputBase)\Language.dll;$(dir-outputBase)\FwKernel.dll;$(dir-outputBase)\Graphite.dll;$(dir-outputBase)\Views.dll"
				 Condition="'$(OS)'=='Windows_NT'"/>
		<Exec Command="mt.exe -outputresource:$(dir-outputBase)\testGenericLib.exe -manifest $(dir-outputBase)\testGenericLib.exe.manifest"
			  Condition="'$(OS)'=='Windows_NT'"/>
		<Exec Command="$(dir-outputBase)\testGenericLib.exe -v -l"
			  WorkingDirectory="$(dir-outputBase)"
			  Condition="'$(OS)'=='Windows_NT' And '$(action)'=='test'" ContinueOnError="true"/>
		<Message Text="Finished building testGenericLib."/>
	</Target>

	<Target Name="GrEngine" DependsOnTargets="GenericLib;FwKernel">
		<CreateProperty Value="all" Condition="'$(action)'=='test'">
			<Output TaskParameter="Value" PropertyName="make-target"/>
		</CreateProperty>
		<Make Condition="'$(OS)'=='Windows_NT'"
			  Makefile="$(fwrt)\Src\Graphite\GrEngine\GrEngine.mak"
			  Configuration="$(config-capital)"
			  BuildRoot="$(fwrt)"
			  WorkingDirectory="$(fwrt)\Src\Graphite\GrEngine"/>
		<Make Condition="'$(OS)'=='Unix'" ToolPath="/usr/bin"
			  Makefile="$(fwrt)/Src/Graphite/GrEngine/Makefile"
			  Configuration="$(config-capital)" Target="$(make-target)"
			  BuildRoot="$(fwrt)"
			  WorkingDirectory="$(fwrt)/Src/Graphite/GrEngine"/>
		<Message Text="Finished building GrEngine."/>
	</Target>

	<Target Name="FwKernel" DependsOnTargets="GenericLib;GenerateCellarConstants;AppCore">
		<CreateProperty Value="all" Condition="'$(action)'=='test'">
			<Output TaskParameter="Value" PropertyName="make-target"/>
		</CreateProperty>
		<Message Text="FwKernel make-target='$(make-target)'"/>
		<Make Condition="'$(OS)'=='Windows_NT'"
			  Makefile="$(fwrt)\Src\Kernel\FwKernel.mak"
			  Configuration="$(config-capital)"
			  BuildRoot="$(fwrt)"
			  WorkingDirectory="$(fwrt)\Src\Kernel"/>
		<Make Condition="'$(OS)'=='Unix'" ToolPath="/usr/bin"
			  Makefile="$(fwrt)/Src/Kernel/Makefile"
			  Configuration="$(config-capital)" Target="$(make-target)"
			  BuildRoot="$(fwrt)"
			  WorkingDirectory="$(fwrt)/Src/Kernel"/>
		<Message Text="Finished building FwKernel."/>
	</Target>

	<Target Name="testFwKernel" DependsOnTargets="GenericLib;FwKernel">
		<CreateProperty Value="check" Condition="'$(action)'=='test'">
			<Output TaskParameter="Value" PropertyName="make-target"/>
		</CreateProperty>
		<Make Condition="'$(OS)'=='Windows_NT'"
			  Makefile="$(fwrt)\Src\Kernel\Test\testFwKernel.mak"
			  Configuration="$(config-capital)"
			  BuildRoot="$(fwrt)"
			  WorkingDirectory="$(fwrt)\Bin"/>
		<Make Condition="'$(OS)'=='Unix'" ToolPath="/usr/bin"
			  Makefile="$(fwrt)/Src/Kernel/Test/Makefile"
			  Configuration="$(config-capital)" Target="$(make-target)"
			  BuildRoot="$(fwrt)"
			  WorkingDirectory="$(fwrt)/Src/Kernel/Test" ContinueOnError="true"/>
		<RegFree Executable="$(dir-outputBase)\testFwKernel.exe"
				 Dlls="$(dir-outputBase)\Language.dll;$(dir-outputBase)\FwKernel.dll;$(dir-outputBase)\Graphite.dll;$(dir-outputBase)\Views.dll"
				 Condition="'$(OS)'=='Windows_NT'"/>
		<Exec Command="mt.exe -outputresource:$(dir-outputBase)\testFwKernel.exe -manifest $(dir-outputBase)\testFwKernel.exe.manifest"
			  Condition="'$(OS)'=='Windows_NT'"/>
		<Exec Command="$(dir-outputBase)\testFwKernel.exe -v -l"
			  WorkingDirectory="$(dir-outputBase)"
			  Condition="'$(OS)'=='Windows_NT' And '$(action)'=='test'" ContinueOnError="true"/>
		<Message Text="Finished building testFwKernel."/>
	</Target>

	<Target Name="AppCore" DependsOnTargets="DebugProcs;GenericLib">
		<CreateProperty Value="all" Condition="'$(action)'=='test'">
			<Output TaskParameter="Value" PropertyName="make-target"/>
		</CreateProperty>
		<Message Text="AppCore make-target='$(make-target)'"/>
		<Make Condition="'$(OS)'=='Unix'" ToolPath="/usr/bin"
			  Makefile="$(fwrt)/Src/AppCore/Makefile"
			  Configuration="$(config-capital)" Target="$(make-target)"
			  BuildRoot="$(fwrt)"
			  WorkingDirectory="$(fwrt)/Src/AppCore"/>
		<Message Text="Finished building AppCore."/>
	</Target>

	<Target Name="Language" DependsOnTargets="GenericLib;FwKernel;ManagedLgIcuCollator;GenerateCellarConstants">
		<CreateProperty Value="all" Condition="'$(action)'=='test'">
			<Output TaskParameter="Value" PropertyName="make-target"/>
		</CreateProperty>
		<Make Condition="'$(OS)'=='Windows_NT'"
			  Makefile="$(fwrt)\Src\Language\Language.mak"
			  Configuration="$(config-capital)"
			  BuildRoot="$(fwrt)"
			  WorkingDirectory="$(fwrt)\Src\Language"/>
		<Make Condition="'$(OS)'=='Unix'" ToolPath="/usr/bin"
			  Makefile="$(fwrt)/Src/Language/Makefile"
			  Configuration="$(config-capital)" Target="$(make-target)"
			  BuildRoot="$(fwrt)"
			  WorkingDirectory="$(fwrt)/Src/Language"/>
		<Message Text="Finished building Language."/>
	</Target>

	<Target Name="testLanguage" DependsOnTargets="GenericLib;Language;FwKernel;Views;GrEngine">
		<CreateProperty Value="check" Condition="'$(action)'=='test'">
			<Output TaskParameter="Value" PropertyName="make-target"/>
		</CreateProperty>
		<Make Condition="'$(OS)'=='Windows_NT'"
			  Makefile="$(fwrt)\Src\Language\Test\testLanguage.mak"
			  Configuration="$(config-capital)"
			  BuildRoot="$(fwrt)"
			  WorkingDirectory="$(fwrt)\Bin"/>
		<Make Condition="'$(OS)'=='Unix'" ToolPath="/usr/bin"
			  Makefile="$(fwrt)/Src/Language/Test/Makefile"
			  Configuration="$(config-capital)" Target="$(make-target)"
			  BuildRoot="$(fwrt)"
			  WorkingDirectory="$(fwrt)/Src/Language/Test" ContinueOnError="true"/>
		<RegFree Executable="$(dir-outputBase)\testLanguage.exe"
				 Dlls="$(dir-outputBase)\Language.dll;$(dir-outputBase)\FwKernel.dll;$(dir-outputBase)\Graphite.dll;$(dir-outputBase)\Views.dll"
				 Condition="'$(OS)'=='Windows_NT'"/>
		<Exec Command="mt.exe -outputresource:$(dir-outputBase)\testLanguage.exe -manifest $(dir-outputBase)\testLanguage.exe.manifest"
			  Condition="'$(OS)'=='Windows_NT'"/>
		<Exec Command="$(dir-outputBase)\testLanguage.exe -v -l"
			  WorkingDirectory="$(dir-outputBase)"
			  Condition="'$(OS)'=='Windows_NT' And '$(action)'=='test'" ContinueOnError="true"/>
		<Message Text="Finished building testLanguage."/>
	</Target>

	<Target Name="Views" DependsOnTargets="GenericLib;Language;KeyboardSwitcher;GenerateCellarConstants"><!-- mktlbs -->
		<CreateProperty Value="all" Condition="'$(action)'=='test'">
			<Output TaskParameter="Value" PropertyName="make-target"/>
		</CreateProperty>
		<Make Condition="'$(OS)'=='Windows_NT'"
			  Makefile="$(fwrt)\Src\views\Views.mak"
			  Configuration="$(config-capital)"
			  BuildRoot="$(fwrt)"
			  WorkingDirectory="$(fwrt)\Src\views"/>
		<Make Condition="'$(OS)'=='Unix'" ToolPath="/usr/bin"
			  Makefile="$(fwrt)/Src/views/Makefile"
			  Configuration="$(config-capital)" Target="$(make-target)"
			  BuildRoot="$(fwrt)"
			  WorkingDirectory="$(fwrt)/Src/views"/>
		<Message Text="Finished building Views."/>
	</Target>

	<Target Name="testViews" DependsOnTargets="GenericLib;Views">
		<CreateProperty Value="check" Condition="'$(action)'=='test'">
			<Output TaskParameter="Value" PropertyName="make-target"/>
		</CreateProperty>
		<Make Condition="'$(OS)'=='Windows_NT'"
			  Makefile="$(fwrt)\Src\views\Test\testViews.mak"
			  Configuration="$(config-capital)"
			  BuildRoot="$(fwrt)"
			  WorkingDirectory="$(fwrt)\Bin"/>
		<Make Condition="'$(OS)'=='Unix'" ToolPath="/usr/bin"
			  Makefile="$(fwrt)/Src/views/Test/Makefile"
			  Configuration="$(config-capital)" Target="$(make-target)"
			  BuildRoot="$(fwrt)"
			  WorkingDirectory="$(fwrt)/Src/views/Test" ContinueOnError="true"/>
		<RegFree Executable="$(dir-outputBase)\testViews.exe"
				 Dlls="$(dir-outputBase)\Language.dll;$(dir-outputBase)\FwKernel.dll;$(dir-outputBase)\Graphite.dll;$(dir-outputBase)\Views.dll"
				 Condition="'$(OS)'=='Windows_NT'"/>
		<Exec Command="mt.exe -outputresource:$(dir-outputBase)\testViews.exe -manifest $(dir-outputBase)\testViews.exe.manifest"
			  Condition="'$(OS)'=='Windows_NT'"/>
		<Exec Command="$(dir-outputBase)\testViews.exe -v -l"
			  WorkingDirectory="$(dir-outputBase)"
			  Condition="'$(OS)'=='Windows_NT' And '$(action)'=='test'" ContinueOnError="true"/>
		<Message Text="Finished building testViews."/>
	</Target>

	<ItemGroup>
		<CellarConstantsInputs Include="$(fwrt)/Src/FDO/MasterFieldWorksModel.xml"/>
		<CellarConstantsInputs Include="$(fwrt)/Src/FDO/FDOGenerate/CellarConstants.vm.h"/>
		<CellarConstantsOutputs Include="$(fwrt)/Output/Common/CellarConstants.h"/>
	</ItemGroup>

	<Target Name="GenerateCellarConstants" DependsOnTargets="CopyCellarBaseConstants"
			Inputs="@(CellarConstantsInputs)" Outputs="@(CellarConstantsOutputs)">
		<MakeDir Directories="$(dir-fwoutputCommon)" Condition="'$(action)'!='clean'"/>
		<FdoGenerate XmlFile="$(fwrt)/Src/FDO/MasterFieldWorksModel.xml"
					 OutputDir="$(dir-fwoutputCommon)"
					 OutputFile="CellarConstants.h"
					 TemplateFile="$(fwrt)/Src/FDO/FDOGenerate/CellarConstants.vm.h"
					 WorkingDirectory="$(fwrt)/Src/FDO"
					 Condition="'$(action)'!='clean'"/>
	</Target>

	<Target Name="CopyCellarBaseConstants" Inputs="$(fwrt)/Src/Kernel/CellarBaseConstants.h" Outputs="$(fwrt)/Output/Common/CellarBaseConstants.h">
		<MakeDir Directories="$(dir-fwoutputCommon)" Condition="'$(action)'!='clean'"/>
		<Copy SourceFiles="$(fwrt)/Src/Kernel/CellarBaseConstants.h"
			  DestinationFolder="$(fwrt)/Output/Common"
			  SkipUnchangedFiles="true" OverwriteReadOnlyFiles="true"
			  Condition="'$(action)'!='clean'"/>
	</Target>

	<PropertyGroup>
		<Original-OBJ_DIR>$(OBJ_DIR)</Original-OBJ_DIR>
		<Original-BUILD4UX>$(BUILD4UX)</Original-BUILD4UX>
		<Original-ANAL_TYPE>$(ANAL_TYPE)</Original-ANAL_TYPE>
	</PropertyGroup>

	<Target Name="mktlbs" DependsOnTargets="GenerateCellarConstants">
		<SetEnvVar Variable="BUILD_OUTPUT" Value="$(dir-fwoutput)" />
		<SetEnvVar Variable="OBJ_DIR" Value="$(dir-fwobj)" />
		<SetEnvVar Variable="BUILD4UX" Value="$(build4ux)"/>
		<SetEnvVar Variable="ANAL_TYPE" Value="performance" Condition="'$(performance)'=='true'"/>
		<Make Condition="'$(OS)'=='Windows_NT'"
			  Makefile="$(fwrt)\Src\Language\Language.mak"
			  Configuration="$(config-capital)"
			  Target="dirs $(dir-fwoutputCommon)\LanguageTlb.tlb"
			  BuildRoot="$(fwrt)"
			  WorkingDirectory="$(fwrt)"/>
		<Make Condition="'$(OS)'=='Windows_NT'"
			  Makefile="$(fwrt)\Src\Kernel\FwKernel.mak"
			  Configuration="$(config-capital)"
			  Target="dirs $(dir-fwoutputCommon)\FwKernelTlb.tlb"
			  BuildRoot="$(fwrt)"
			  WorkingDirectory="$(fwrt)"/>
		<Make Condition="'$(OS)'=='Windows_NT'"
			  Makefile="$(fwrt)\Src\views\Views.mak"
			  Configuration="$(config-capital)"
			  Target="dirs $(dir-fwoutputCommon)\ViewsTlb.tlb"
			  BuildRoot="$(fwrt)"
			  WorkingDirectory="$(fwrt)"/>
		<SetEnvVar Variable="BUILD_OUTPUT" Value="$(Original-BUILD_OUTPUT)" />
		<SetEnvVar Variable="OBJ_DIR" Value="$(Original-OBJ_DIR)" />
		<SetEnvVar Variable="BUILD4UX" Value="$(Original-BUILD4UX)" />
		<SetEnvVar Variable="ANAL_TYPE" Value="$(Original-ANAL_TYPE)" />
	</Target>

	<Target Name="remakefw" DependsOnTargets="CleanAll;MakeDirs;IcuData;setRegistryValues;CopyDlls;mkall"/>

	<UsingTask TaskName="ForceDelete" AssemblyFile="FwBuildTasks.dll"/>

	<Target Name="CleanAll">
		<!-- remove the Obj and Output directories -->
		<ForceDelete Files="$(dir-fwobj);$(dir-fwoutput)"/>
		<ForceDelete Files="$(fwrt)/Output" Condition="'$(OS)'=='Unix'"/>
		<!-- remove other directories and files created during the build process -->
		<ForceDelete Files="@(IcuDataFiles)"/>

		<Message Text="Finished deleting the output directories!"/>
	</Target>

	<Target Name="CopyDlls">
		<!-- .Net assemblies -->
		<Copy SourceFiles="$(fwrt)/DistFiles/LinqBridge.dll" DestinationFolder="$(dir-outputBase)"
			  SkipUnchangedFiles="true" OverwriteReadOnlyFiles="true"/>
		<Copy SourceFiles="$(fwrt)/DistFiles/log4net.dll" DestinationFolder="$(dir-outputBase)"
			  SkipUnchangedFiles="true" OverwriteReadOnlyFiles="true"/>
		<Copy SourceFiles="$(fwrt)/Lib/Common/Interop.ResourceDriver.dll" DestinationFolder="$(dir-outputBase)"
			  SkipUnchangedFiles="true" OverwriteReadOnlyFiles="true"/>
		<!-- Linux shared libraries -->
		<Copy SourceFiles="$(fwrt)/DistFiles/libxample32.so" DestinationFolder="$(dir-outputBase)"
			  SkipUnchangedFiles="true" OverwriteReadOnlyFiles="true" Condition="'$(OS)'=='Unix'"/>
		<Copy SourceFiles="$(fwrt)/DistFiles/libxample64.so" DestinationFolder="$(dir-outputBase)"
			  SkipUnchangedFiles="true" OverwriteReadOnlyFiles="true" Condition="'$(OS)'=='Unix'"/>
		<!-- Windows dynamically loaded libraries -->
		<Copy SourceFiles="$(fwrt)/DistFiles/xample.dll" DestinationFolder="$(dir-outputBase)"
			  SkipUnchangedFiles="true" OverwriteReadOnlyFiles="true" Condition="'$(OS)'=='Windows_NT'"/>
		<Copy SourceFiles="$(fwrt)/DistFiles/Patr100.dll" DestinationFolder="$(dir-outputBase)"
			  SkipUnchangedFiles="true" OverwriteReadOnlyFiles="true" Condition="'$(OS)'=='Windows_NT'"/>
		<!-- Needed for at least one set of unit tests. Since the installer combines distfiles with output/release, probably not necessary otherwise.
		Possibly could be moved into a buildInclude for projects that need it. Old version did not copy for remakele-->
		<Copy SourceFiles="$(fwrt)/DistFiles/Utilities.dll" DestinationFolder="$(dir-outputBase)"
			  SkipUnchangedFiles="true" OverwriteReadOnlyFiles="true"/>
	</Target>

	<Target Name="setRegistryValues" Condition="'$(OS)'=='Unix' Or '$(UserIsAdmin)'=='True'" DependsOnTargets="initLinux;initWindows">
		<WriteRegistry Hive="LocalMachine"
					   Key="SOFTWARE\SIL\FieldWorks\$(FWMAJOR).0\RootCodeDir"
					   Value="$(dir-fwdistfiles)"/>
		<WriteRegistry Hive="LocalMachine"
					   Key="SOFTWARE\SIL\FieldWorks\$(FWMAJOR).0\RootDataDir"
					   Value="$(dir-fwdistfiles)"/>
		<WriteRegistry Hive="LocalMachine"
					   Key="SOFTWARE\SIL\FieldWorks\$(FWMAJOR).0\ProjectsDir"
					   Value="$(dir-fwdistfiles)\Projects"/>
		<WriteRegistry Hive="LocalMachine"
					   Key="SOFTWARE\SIL\Icu40DataDir"
					   Value="$(dir-icuData)"/>
		<WriteRegistry Hive="LocalMachine"
					   Key="SOFTWARE\SIL\Icu40Dir"
					   Value="$(dir-icu)"/>
		<WriteRegistry Hive="LocalMachine"
					   Key="SOFTWARE\SIL\SilEncConverters40\RootDir"
					   Value="$(fwrt)\DistFiles\Windows\EC Common"
					   Condition="'$(OS)'=='Windows_NT'"/>
		<WriteRegistry Hive="LocalMachine"
					   Key="SOFTWARE\SIL\SilEncConverters40\DeveloperPluginDir"
					   Value="$(fwrt)\DistFiles\Windows\EC\EC\Plugins"
					   Condition="'$(OS)'=='Windows_NT'"/>
		<WriteRegistry Hive="LocalMachine"
					   Key="SOFTWARE\SIL\SilEncConverters40\RootDir"
					   Value="$(dir-outputBase)"
					   Condition="'$(OS)'=='Unix'"/>
		<WriteRegistry Hive="LocalMachine"
					   Key="SOFTWARE\SIL\SilEncConverters40\DeveloperPluginDir"
					   Value="$(dir-outputBase)/EC/Plugins"
					   Condition="'$(OS)'=='Unix'"/>
	</Target>

</Project>
