<Project Sdk="Microsoft.NET.Sdk">
  <Import Project="../../Build/FwBuildTasks.props" />

  <PropertyGroup>
    <RootNamespace>SIL.FieldWorks.Common.ViewsInterfaces</RootNamespace>
    <Description>ViewsInterfaces</Description>
    <OutputCommonPath>../../Output/Common/</OutputCommonPath>
    <NoWarn>$(NoWarn);CS2002</NoWarn>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="GitVersion.MsBuild" Version="5.10.3" PrivateAssets="All" />
    <PackageReference Include="Icu4c.Win.Fw.Bin" Version="70.1.152" />
    <PackageReference Include="Icu4c.Win.Fw.Lib" Version="70.1.152" />
    <PackageReference Include="SIL.LCModel" Version="10.2.0-beta0067" />
    <PackageReference Include="SIL.LCModel.Build.Tasks" Version="10.2.0-beta0067" GeneratePathProperty="true" PrivateAssets="All" />
    <PackageReference Include="SIL.LCModel.Core" Version="10.2.0-beta0067" GeneratePathProperty="true" />
  </ItemGroup>
  
  <ItemGroup>
    <ViewsSourceIdl Include="$(OutputCommonPath)ViewsTlb.idl" />
    <ViewsIdhFiles Include="../views/Render.idh" />
    <ViewsIdhFiles Include="../views/Views.idh" />
    <ViewsInputs Include="@(ViewsIdhFiles)" />
    <ViewsInputs Include="@(ViewsSourceIdl)" />
  </ItemGroup>

  <Target Name="GenerateViewsCs" Inputs="@(ViewsInputs)" Outputs="Views.cs" BeforeTargets="CoreCompile">
    <ItemGroup>
      <UsingNamespaces Include="SIL.LCModel.Core.KernelInterfaces" />
      <UsingNamespaces Include="SIL.LCModel.Utils" />
    </ItemGroup>
    <PropertyGroup>
      <IdlImpVer>3.0.1-beta0008</IdlImpVer> <!-- Pin to 3.0.1-beta0008 because following versions generate a Views.cs that doesn't compile. -->
      <ViewsSourceIdlProp>@(ViewsSourceIdl)</ViewsSourceIdlProp>
      <ViewsTlbSrc>$([System.IO.Path]::GetFullPath('$(ViewsSourceIdlProp)'))</ViewsTlbSrc>
      <ViewsRefsJson>$(PkgSIL_LCModel_Core)\contentFiles\KernelInterfaces\FwKernelTlb.json</ViewsRefsJson>
      <IdlImporterXmlPath>$(PkgSIL_LCModel_Build_Tasks)\tools\net461\IDLImporter.xml</IdlImporterXmlPath>
    </PropertyGroup>
    <Error Condition="!Exists('$(ViewsTlbSrc)')" Text="ViewsTlbSrc file:'$(ViewsTlbSrc)' is missing." />
    <Error Condition="!Exists('$(ViewsRefsJson)')" Text="ViewsRefsJson file:'$(ViewsRefsJson)' is missing." />
    <Error Condition="!Exists('$(IdlImporterXmlPath)')" Text="IdlImporterXml file: '$(IdlImporterXmlPath)' is missing." />
    <!-- Install our dotnet global tool used for generating Views.cs in the ViewsInterfaces project -->
    <!-- Installing in net461 builds works, but installing in net472 builds fails, claiming to require net7. Install only if needed. -->
    <Exec Command="where idlimport || dotnet tool update --global SIL.IdlImporter.Tool --version $(IdlImpVer)" />
    <Exec Command="idlimport /c &quot;$(IdlImporterXmlPath)&quot; /o $(MSBuildProjectDirectory)\Views.cs /i &quot;@(ViewsIdhFiles)&quot; /n SIL.FieldWorks.Common.ViewsInterfaces /u &quot;@(UsingNamespaces)&quot; /r &quot;$(ViewsRefsJson)&quot; &quot;$(ViewsTlbSrc)&quot;" />
    <ItemGroup>
      <!-- (Hasso) 2022.12: there are three CS2002 warnings about this being included multiple times (for each project that references this one),
        but removing this include causes it not to be included. -->
      <Compile Include="$(MSBuildProjectDirectory)\Views.cs" />
   </ItemGroup>
  </Target>

  <Target Name="CopyKernelFiles">
    <!-- Copy the .idh files from liblcm into the Kernel project so that it can use them when it builds -->
    <Copy SourceFiles="@(SilLcModelCoreKernelInterfaces)" DestinationFolder="../Kernel" />
  </Target>


  <Target Name="CustomClean" AfterTargets="Clean">
    <Delete Files="@(OutputFiles)" ContinueOnError="true" />
    <Delete Files="Views.cs;$(OutputCommonPath)ViewsTlb.iip;$(OutputCommonPath)ViewsTlb.json" ContinueOnError="true" />
  </Target>

  <ItemGroup>
    <CellarConstantsInputs Include="$(SilLCModelFile)" />
    <CellarConstantsInputs Include="../Kernel/CellarConstants.vm.h" />
    <CellarConstantsOutputs Include="../../Output/Common/CellarConstants.h" />
  </ItemGroup>

  <Target Name="GenerateCellarConstants" DependsOnTargets="CopyCellarBaseConstants" Inputs="@(CellarConstantsInputs)" Outputs="@(CellarConstantsOutputs)">
    <LcmGenerate XmlFile="@(SilLCModelFile)" OutputDir="../../Output/Common/" OutputFile="CellarConstants.h" TemplateFile="../Kernel/CellarConstants.vm.h" WorkingDirectory="$(SilLCModelFile)" HandGeneratedDir="@(SilLCModelHandgeneratedFilesDir)" />
    <Message Importance="high" Text="Generated CellarConstants files" />
  </Target>

  <Target Name="CopyCellarBaseConstants" Inputs="../Kernel/CellarBaseConstants.h" Outputs="../../Output/Common/CellarBaseConstants.h" DependsOnTargets="CopyKernelFiles">
    <MakeDir Directories="../../Output/Common/" />
    <Copy SourceFiles="../Kernel/CellarBaseConstants.h" DestinationFolder="../../Output/Common/" SkipUnchangedFiles="true" OverwriteReadOnlyFiles="true" />
  </Target>

</Project>