<?xml version="1.0" encoding="UTF-8"?>
<!-- Targets related to installers. This file is included in FieldWorks.build -->
<project name="WixInstaller" default="all" xmlns="http://fieldworks.sil.org/nant/fwnant.xsd">

	<!-- WiX 3 folder -->
	<property name="wix.dir" value="${path::combine(environment::get-variable('WIX'), 'bin')}" readonly="true" if="${environment::variable-exists('WIX')}"/>

	<if test="${property::exists('wix.dir')}">
		<!-- Load the WiX3 tasks -->
		<loadtasks assembly="${wix.dir}\Microsoft.Tools.WindowsInstallerXml.NAntTasks.dll" if="${environment::variable-exists('WIX')}"/>
	</if>

	<target name="TestWixPresent" description="Tests that WIX has been installed">
		<if test="${not property::exists('wix.dir')}">
			<fail message="********************************************************************************WIX has not been installed on this computer. Please run the WIX installer (found in ${fwroot}\Installer\WIX), then quit this DOS window and start up another, to allow the new Environment to be used."/>
		</if>
	</target>

	<target name="Installers" description="Handle everything related to FW installers."
		depends="overnight-init,TestWixPresent">
		<echo message="******************************************************************"/>
		<tstamp/>
		<echo message="Start building installers."/>
		<delete failonerror="false" verbose="false">
			<fileset>
				<include name="${fwroot}/DistFiles/**/asserts.log" />
			</fileset>
		</delete>
		<call target="WixCleanUpPrevious"/>
		<echo message="******************************************************************"/>
		<tstamp/>
		<echo message="Building FieldWorks ${config} and SEC installers."/>
		<call target="BuildFwAndSecInstaller"/>
		<tstamp/>
		<echo message="******************************************************************"/>
		<echo message="Building installer for FW without TE..."/>
		<call target="BuildFwNoTeInstaller"/>
		<echo message="******************************************************************"/>
		<echo message="Computing MD5 checksums for FW installers..."/>
		<exec program="cmd.exe" commandline='/c "ComputeMd5Checksums.bat"' workingdir="${fwroot}/Installer"/>
		<echo message="******************************************************************"/>
		<tstamp/>
		<echo message="Finished building ${config} installer."/>
	</target>

	<target name="installer" description="Builds the FW installer"
			depends="TestWixPresent,IcuData">
		<tstamp/>
		<call target="BuildFwInstaller"/>
		<tstamp/>
	</target>

	<target name="WixCleanUpPrevious">
		<echo message="Deleting previous installers..."/>
		<delete failonerror="false">
			<fileset basedir="${fwroot}/Installer">
				<include name="*.msi"/>
				<include name="*.cab"/>
				<include name="*.md5"/>
			</fileset>
		</delete>
		<echo message="...Done deleting all WIX output."/>
	</target>

	<target name="FwWixPreprocess" description="Pre-process the FW WIX source files.">
		<echo message="Deleting previous WIX preprocessed files..."/>
		<delete failonerror="false">
			<fileset basedir="${fwroot}/Installer">
				<include name="RegLibraryAddenda.xml"/>
				<include name="ProcessedAutoFiles.wxs"/>
				<include name="ProcessedFiles.wxs"/>
				<include name="ProcessedMergeModules.wxs"/>
				<include name="ProcessedAutoFiles.wixobj"/>
				<include name="ProcessedFiles.wixobj"/>
				<include name="ProcessedMergeModules.wixobj"/>
			</fileset>
		</delete>
		<echo message="...Done deleting WIX preprocessed source files and compiled objects."/>
		<echo message="Cleanup ICU data files..."/>
		<call target="IcuData-nodep" cascade="true"/>
		<echo message="Preprocessing Merge Modules..."/>
		<exec workingdir="${fwroot}/Installer" program="WScript.exe" commandline="${fwroot}/Installer/ProcessMergeModules.js" />
		<echo message="Generating AutoFiles.wxs..."/>
		<exec workingdir="${fwroot}/Installer" program="${fwroot}/Installer/GenerateFilesSource.exe" commandline="${config}" failonerror="true" />
		<echo message="Preprocessing Files..."/>
		<exec workingdir="${fwroot}/Installer" program="${fwroot}/Installer/ProcessFiles.exe" commandline="${config}" failonerror="true" />
		<echo message="Testing installer integrity..."/>
		<exec workingdir="${fwroot}/Installer" program="${fwroot}/Installer/TestInstallerIntegrity.exe" commandline="silent" />
		<echo message="Finished preprocessing FW WIX sources."/>
	</target>

	<target name="FwWixCompile" description="Compile the FW WIX sources." depends="TestWixPresent,FwWixPreprocess">
		<echo message="Deleting previous FW WIX compiled objects..."/>
		<delete failonerror="false">
			<fileset basedir="${fwroot}/Installer">
				<include name="Actions.wixobj" />
				<include name="CopyFiles.wixobj" />
				<include name="Environment.wixobj" />
				<include name="Features.wixobj" />
				<include name="FW.wixobj" />
				<include name="FwUI.wixobj" />
				<include name="PatchCorrections.wixobj" />
				<include name="ProcessedAutoFiles.wixobj" />
				<include name="ProcessedFiles.wixobj" />
				<include name="ProcessedMergeModules.wixobj" />
				<include name="Registry.wixobj" />
				<include name="Shortcuts.wixobj" />
			</fileset>
		</delete>
		<echo message="...Done deleting FW WIX compiled objects."/>
		<echo message="Compiling FW WIX installer source files..."/>
		<candle out="${fwroot}/Installer/" exedir="${wix.dir}" >
			<arg line="-sw1044" />
			<sources basedir="${fwroot}/Installer">
				<include name="Actions.wxs" />
				<include name="CopyFiles.wxs" />
				<include name="Environment.wxs" />
				<include name="Features.wxs" />
				<include name="FW.wxs" />
				<include name="FwUI.wxs" />
				<include name="PatchCorrections.wxs" />
				<include name="ProcessedAutoFiles.wxs" />
				<include name="ProcessedMergeModules.wxs" />
				<include name="Registry.wxs" />
				<include name="Shortcuts.wxs" />
			</sources>
		</candle>
		<!-- Separate instance of Candle for WIX sources needing the WixUtilExtension: -->
		<candle out="${fwroot}/Installer/" exedir="${wix.dir}" extensions="WixUtilExtension" >
			<arg line="-sw1044" />
			<sources basedir="${fwroot}/Installer">
				<include name="ProcessedFiles.wxs" />
			</sources>
		</candle>
		<echo message="Finished compiling FW WIX sources."/>
	</target>

	<target name="BuildFwAndSecInstaller" description="Build the FW and SEC installers" depends="TestWixPresent,BuildFwInstaller,BuildSecInstaller">
		<echo message="Built FW and SEC installers."/>
	</target>

	<target name="BuildFwInstaller" description="Build the FW installer" depends="TestWixPresent,FwWixCompile,BuildFwMergeModules">
		<call target="LinkFwInstaller"/>
	</target>

	<target name="LinkFwInstaller" description="Link the FW installer" depends="TestWixPresent" >
		<echo message="Deleting previous FW WIX linker output..."/>
		<delete failonerror="false">
			<fileset basedir="${fwroot}/Installer">
				<include name="SetupFW.msi"/>
				<include name="*.cab"/>
			</fileset>
		</delete>
		<echo message="...Done deleting FW WIX linker output."/>
		<echo message="Linking FW WIX installer files..."/>
		<light out="${fwroot}/Installer/SetupFW.msi" exedir="${wix.dir}" rebuild="true" extensions="WixUtilExtension"
					 suppressices="ICE03;ICE47;ICE48;ICE57;ICE60;ICE69;ICE82;ICE83">
			<arg line="-sw1055 -sw1056" />
			<sources basedir="${fwroot}/Installer">
				<include name="Actions.wixobj"/>
				<include name="CopyFiles.wixobj"/>
				<include name="Environment.wixobj"/>
				<include name="Features.wixobj"/>
				<include name="FW.wixobj"/>
				<include name="FwUI.wixobj"/>
				<include name="PatchCorrections.wixobj"/>
				<include name="ProcessedMergeModules.wixobj"/>
				<include name="ProcessedAutoFiles.wixobj"/>
				<include name="ProcessedFiles.wixobj"/>
				<include name="Registry.wixobj"/>
				<include name="Shortcuts.wixobj"/>
			</sources>
		</light>
		<echo message="Finished building FW WIX installer."/>
	</target>

	<target name="BuildFwNoTeInstaller" description="Build the FW SE installer (without TE)" depends="TestWixPresent">
		<echo message="Running script to strip out TE stuff..."/>
		<exec workingdir="${fwroot}/Installer" program="WScript.exe" commandline="${fwroot}/Installer/StripOutTE.js" />

		<echo message="Compiling FW (no TE) WIX installer source files..."/>
		<candle out="${fwroot}/Installer/" exedir="${wix.dir}" >
			<arg line="-sw1044" />
			<sources basedir="${fwroot}/Installer">
				<include name="CopyFiles_No_TE.wxs" />
				<include name="Features_No_TE.wxs" />
				<include name="Fw_No_TE.wxs" />
				<include name="FwUI_No_TE.wxs" />
				<include name="PatchCorrections_No_TE.wxs" />
				<include name="ProcessedAutoFiles_No_TE.wxs" />
				<include name="Registry_No_TE.wxs" />
				<include name="Shortcuts_No_TE.wxs" />
			</sources>
		</candle>
		<!-- Separate instance of Candle for WIX sources needing the WixUtilExtension: -->
		<candle out="${fwroot}/Installer/" exedir="${wix.dir}" extensions="WixUtilExtension" >
			<arg line="-sw1044" />
			<sources basedir="${fwroot}/Installer">
				<include name="ProcessedFiles_No_TE.wxs" />
			</sources>
		</candle>
		<echo message="Finished compiling FW (no TE) WIX sources."/>
		<echo message="Deleting previous FW (no TE) WIX linker output..."/>
		<delete failonerror="false">
			<fileset basedir="${fwroot}/Installer">
				<include name="SetupFW_SE.msi"/>
				<include name="*SE.cab"/>
			</fileset>
		</delete>
		<echo message="...Done deleting FW (no TE) WIX linker output."/>
		<echo message="Linking FW (no TE) WIX installer files..."/>
		<light out="${fwroot}/Installer/SetupFW_SE.msi" exedir="${wix.dir}" rebuild="true" extensions="WixUtilExtension"
					 suppressices="ICE03;ICE47;ICE48;ICE57;ICE60;ICE69;ICE82;ICE83">
			<arg line="-sw1055 -sw1056" />
			<sources basedir="${fwroot}/Installer">
				<include name="Actions.wixobj"/>
				<include name="CopyFiles_No_TE.wixobj"/>
				<include name="Environment.wixobj"/>
				<include name="Features_No_TE.wixobj"/>
				<include name="FW_No_TE.wixobj"/>
				<include name="FwUI_No_TE.wixobj"/>
				<include name="PatchCorrections_No_TE.wixobj"/>
				<include name="ProcessedMergeModules.wixobj"/>
				<include name="ProcessedAutoFiles_No_TE.wixobj"/>
				<include name="ProcessedFiles_No_TE.wixobj"/>
				<include name="Registry_No_TE.wixobj"/>
				<include name="Shortcuts_No_TE.wixobj"/>
			</sources>
		</light>
		<echo message="Finished building FW (no TE) WIX installer."/>
	</target>

	<target name="SecWixPreprocess" description="Pre-process WIX source files for SEC installer.">
		<echo message="Deleting previous SEC WIX preprocessed source files and compiled objects..."/>
		<delete failonerror="false">
			<fileset basedir="${fwroot}/Installer">
				<include name="EcProcessedMergeModules.wxs"/>
			</fileset>
		</delete>
		<echo message="...Done deleting SEC WIX preprocessed source files and compiled objects."/>
		<echo message="Preprocessing SEC WIX sources..."/>
		<exec workingdir="${fwroot}/Installer" program="WScript.exe" commandline="${fwroot}/Installer/EcProcessMergeModules.js" />
		<echo message="Finished preprocessing SEC WIX sources."/>
	</target>

	<target name="SecWixCompile" description="Compile SEC installer source files." depends="TestWixPresent,SecWixPreprocess">
		<echo message="Deleting previous SEC WIX compiled objects..."/>
		<delete failonerror="false">
			<fileset basedir="${fwroot}/Installer">
				<include name="EC.wixobj"/>
				<include name="EcActions.wixobj"/>
				<include name="EcFeatures.wixobj"/>
				<include name="EcUI.wixobj"/>
				<include name="EcProcessedMergeModules.wixobj"/>
				<include name="EcFiles.wixobj"/>
			</fileset>
		</delete>
		<echo message="...Done deleting SEC WIX compiled objects."/>
		<echo message="Compiling SEC WIX installer source files..."/>
		<candle out="${fwroot}/Installer/" exedir="${wix.dir}" >
			<arg line="-sw1044" />
			<sources basedir="${fwroot}/Installer">
				<include name="EC.wxs" />
				<include name="EcActions.wxs" />
				<include name="EcFeatures.wxs" />
				<include name="EcUI.wxs" />
				<include name="EcProcessedMergeModules.wxs" />
				<include name="EcFiles.wxs" />
			</sources>
		</candle>
		<echo message="Finished compiling SEC WIX sources."/>
	</target>

	<target name="BuildSecInstaller" description="Build SEC installer" depends="TestWixPresent,SecWixCompile,BuildSecMergeModules">
		<echo message="Deleting previous SEC WIX linker output..."/>
		<delete failonerror="false">
			<fileset basedir="${fwroot}/Installer">
				<include name="SetupEC.msi"/>
			</fileset>
		</delete>
		<echo message="...Done deleting SEC WIX linker output."/>
		<echo message="Linking SEC WIX installer files..."/>
		<light out="${fwroot}/Installer/SetupEC.msi" exedir="${wix.dir}" rebuild="true" extensions="WixUtilExtension"
					 suppressices="ICE03;ICE08;ICE30;ICE47;ICE48;ICE57;ICE60;ICE69;ICE82;ICE83">
			<arg line="-sw1055 -sw1056" />
			<sources basedir="${fwroot}/Installer">
				<include name="Ec.wixobj"/>
				<include name="EcActions.wixobj"/>
				<include name="EcFeatures.wixobj"/>
				<include name="EcFiles.wixobj"/>
				<include name="EcProcessedMergeModules.wixobj"/>
				<include name="EcUI.wixobj"/>
			</sources>
		</light>
		<echo message="Finished building SEC WIX installer."/>
	</target>

	<target name="BuildAllMergeModules"
					description="Build the FW and SEC merge modules"
					depends="BuildEcOnlyMergeModules,BuildFwOnlyMergeModules,BuildFwEcSharedMergeModules">
		<echo message="Built all merge modules."/>
	</target>

	<target name="BuildSecMergeModules"
					description="Build the SEC merge modules"
					depends="BuildEcOnlyMergeModules,BuildFwEcSharedMergeModules">
		<echo message="Built SEC merge modules."/>
	</target>

	<target name="BuildFwMergeModules"
					description="Build the FW merge modules"
					depends="BuildFwOnlyMergeModules,BuildFwEcSharedMergeModules">
		<echo message="Built FW merge modules."/>
	</target>

	<target name="BuildEcOnlyMergeModules" description="Build the merge modules used exclusively in SEC installer.">

		<echo message="Building merge modules exclusive to SEC."/>

		<!--a KB update fix specific to SEC-->
		<property name="MergeModule" value="MS KB908002 Fix"/>
		<call target="BuildMergeModule"/>

		<!--Open/LibreOffice extension for SEC-->
		<property name="MergeModule" value="OO_Ling_Tools"/>
		<call target="BuildMergeModule"/>

		<!--EncConverter specifics for SEC-->
		<property name="MergeModule" value="SEC_EC_40"/>
		<call target="BuildMergeModule"/>

		<!--ICU specifics for SEC-->
		<property name="MergeModule" value="SEC_ICU40"/>
		<call target="BuildMergeModule"/>

		<!--Perl specifics for SEC-->
		<property name="MergeModule" value="SEC_PerlEC"/>
		<call target="BuildMergeModule"/>

		<!--Python specifics for SEC-->
		<property name="MergeModule" value="SEC_PythonEC"/>
		<call target="BuildMergeModule"/>

	</target>

	<target name="BuildFwOnlyMergeModules" description="Build the merge modules used exclusively in FW installer.">

		<echo message="Building merge modules exclusive to FW."/>

		<!--EncConverter specifics for FW-->
		<property name="MergeModule" value="FW_EC_40"/>
		<call target="BuildMergeModule"/>

		<!--ICU specifics for FW-->
		<property name="MergeModule" value="FW_ICU40"/>
		<call target="BuildMergeModule"/>

		<!--Perl specifics for FW-->
		<property name="MergeModule" value="FW_PerlEC"/>
		<call target="BuildMergeModule"/>

		<!--Python specifics for FW-->
		<property name="MergeModule" value="FW_PythonEC"/>
		<call target="BuildMergeModule"/>
	</target>

	<target name="BuildFwEcSharedMergeModules" description="Build the merge modules shared by both SEC and FW installers.">

		<echo message="Building merge modules shared by FW and SEC."/>

		<property name="MergeModule" value="EC_40"/>
		<property name="IncludeExtension" value="true"/>
		<property name="CandleArguments" value="-sw1006 -sw1086"/>
		<property name="LightArguments" value="-sw1072"/>
		<call target="BuildMergeModule"/>

		<property name="MergeModule" value="EcFolderACLs"/>
		<property name="IncludeExtension" value="true"/>
		<property name="LightArguments" value="-sw1072 -sw1079"/>
		<call target="BuildMergeModule"/>

		<property name="MergeModule" value="ICU040"/>
		<property name="IncludeExtension" value="true"/>
		<property name="CandleArguments" value="-sw1006 -sw1086"/>
		<property name="LightArguments" value="-sw1072 "/>
		<call target="BuildMergeModule"/>

		<property name="MergeModule" value="ICUECHelp"/>
		<call target="BuildMergeModule"/>

		<property name="MergeModule" value="Managed Install Fix"/>
		<property name="CandleArguments" value="-sw1006 -sw1086"/>
		<call target="BuildMergeModule"/>

		<property name="MergeModule" value="PerlEC"/>
		<property name="CandleArguments" value="-sw1006 -sw1086"/>
		<property name="LightArguments" value="-sice:ICE03"/>
		<call target="BuildMergeModule"/>

		<property name="MergeModule" value="PythonEC"/>
		<property name="LightArguments" value="-sice:ICE03"/>
		<call target="BuildMergeModule"/>

		<property name="MergeModule" value="SetPath"/>
		<property name="CandleArguments" value="-sw1006 -sw1086"/>
		<property name="LightArguments" value="-sw1079"/>
		<call target="BuildMergeModule"/>

	</target>

	<target name="AnnihilateOutOfDateMMFiles" description="Delete a merge module and all the intermediate files used to build it.">
		<!-- Requires that you set the property "MergeModule" to the module's name (e.g. ICU040) before calling. -->
		<delete failonerror="false">
			<fileset basedir="${fwroot}\Installer">
				<include name="${MergeModule}.msm"/>
				<include name="WixLink${MergeModule}.log"/>
				<include name="${MergeModule}.mmp.wixobj"/>
				<include name="${MergeModule}.mmp.wxs"/>
				<include name="${MergeModule}.mmp.wxs.log"/>
			</fileset>
		</delete>
	</target>

	<target name="PreprocessMergeModule" description="Run the JavaScript to pre-process a merge module.">
		<!-- Requires that you set the property "MergeModule" to the module's name (e.g. ICU040) before calling. -->
		<exec workingdir="${fwroot}\Installer" program="WScript.exe" commandline="${fwroot}\Installer\ProcessWixMMs.js ${config} &quot;${MergeModule}.mm.wxs&quot;"
			  failonerror="false" resultproperty="ProcessWixMMsResult" />
		<if test="${int::parse(ProcessWixMMsResult) != 0}">
			<if test="${int::parse(ProcessWixMMsResult) == -1}">
				<fail message="Error while preprocessing ${MergeModule}.mm.wxs. See Installer\ProcessWixMMs.log for details."/>
			</if>
		</if>
	</target>

	<target name="CompileMergeModule" description="Run the WIX Candle utility to compile a merge module." depends="TestWixPresent">
		<!-- Requires that you set the property "MergeModule" to the module's name (e.g. ICU040) before calling. -->

		<if test="${not property::exists('CandleArguments')}">
			<property name="CandleArguments" value=""/>
		</if>

		<candle out="${fwroot}\Installer\" exedir="${wix.dir}" >
			<arg line="${CandleArguments}" />
			<sources basedir="${fwroot}\Installer">
				<include name="${MergeModule}.mmp.wxs" />
			</sources>
		</candle>

		<property name="CandleArguments" value=""/>
	</target>

	<target name="CompileMergeModuleWithWixExtension"
					description="Run the WIX Candle utility to compile a merge module, including the WIX Util Extension."
					depends="TestWixPresent">
		<!-- Requires that you set the property "MergeModule" to the module's name (e.g. ICU040) before calling. -->

		<if test="${not property::exists('CandleArguments')}">
			<property name="CandleArguments" value=""/>
		</if>

		<candle out="${fwroot}\Installer\" exedir="${wix.dir}" extensions="WixUtilExtension" >
			<arg line="${CandleArguments}" />
			<sources basedir="${fwroot}\Installer">
				<include name="${MergeModule}.mmp.wxs" />
			</sources>
		</candle>

		<property name="CandleArguments" value=""/>
	</target>

	<target name="LinkMergeModule" description="Run the WIX Light utility to link a merge module." depends="TestWixPresent">
		<!-- Requires that you set the property "MergeModule" to the module's name (e.g. ICU040) before calling. -->

		<if test="${not property::exists('LightArguments')}">
			<property name="LightArguments" value=""/>
		</if>

		<light out="${fwroot}\Installer\${MergeModule}.msm" exedir="${wix.dir}" rebuild="true">
			<arg line="${LightArguments}" />
			<sources basedir="${fwroot}\Installer">
				<include name="${MergeModule}.mmp.wixobj"/>
			</sources>
		</light>

		<property name="LightArguments" value=""/>
	</target>

	<target name="LinkMergeModuleWithWixExtension"
					description="Run the WIX Light utility to link a merge module, including the WIX Util Extension."
					depends="TestWixPresent">
		<!-- Requires that you set the property "MergeModule" to the module's name (e.g. ICU040) before calling. -->

		<if test="${not property::exists('LightArguments')}">
			<property name="LightArguments" value=""/>
		</if>

		<light out="${fwroot}\Installer\${MergeModule}.msm" exedir="${wix.dir}" extensions="WixUtilExtension" rebuild="true">
			<arg line="${LightArguments}" />
			<sources basedir="${fwroot}\Installer">
				<include name="${MergeModule}.mmp.wixobj"/>
			</sources>
		</light>

		<property name="LightArguments" value=""/>
	</target>

	<target name="BuildMergeModule"
					description="Build a merge module. Requires that you set the property MergeModule before calling.">
		<!-- Set the property "IncludeExtension" to "true" if you want the wixca library to be included. -->
		<!-- The property "IncludeExtension" is reset to "false" in any case during this target. -->

		<echo message="Building merge module ${MergeModule}."/>

		<if test="${not property::exists('IncludeExtension')}">
			<property name="IncludeExtension" value="false"/>
		</if>

		<!-- Delete previous intermediate files: -->
		<call target="AnnihilateOutOfDateMMFiles"/>
		<!-- Pre-process source file: -->
		<call target="PreprocessMergeModule"/>
		<!-- Compile pre-processed file: -->
		<if test="${IncludeExtension == 'true'}">
			<call target="CompileMergeModuleWithWixExtension"/>
		</if>
		<if test="${IncludeExtension != 'true'}">
			<call target="CompileMergeModule"/>
		</if>
		<!-- Link merge module: -->
		<if test="${IncludeExtension == 'true'}">
			<call target="LinkMergeModuleWithWixExtension"/>
		</if>
		<if test="${IncludeExtension != 'true'}">
			<call target="LinkMergeModule"/>
		</if>
		<!-- Reset IncludeExtension property: -->
		<property name="IncludeExtension" value="false"/>
	</target>

</project>
